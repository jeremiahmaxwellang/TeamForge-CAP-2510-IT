<!-- Player Comparison Overlay -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Comparison</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="/d3.v3.js"></script>
    <script type="text/javascript" src="/radar-chart.js"></script>
</head>
<body>
    <div class="overlay">
        <div class="comparison-container">
            <div class="comparison-header">Player Comparison</div>

            <!-- Player Selection Section -->
            <div class="player-selection">
                <div class="player-selector">
                    <label for="player1-select">Player 1:</label>
                    <select id="player1-select">
                        <option value="">Select a player...</option>
                    </select>
                </div>
                <div class="player-selector">
                    <label for="player2-select">Player 2:</label>
                    <select id="player2-select">
                        <option value="">Select a player...</option>
                    </select>
                </div>
            </div>

            <!-- Comparison Content -->
            <div class="comparison-content">
                <!-- Player 1 Card -->
                <div class="player-card" id="card-player1">
                    <img id="pfp-player1" src="/images/sample_profile.png" alt="Player 1" class="player-pfp" style="border-color: #FFD700;">
                    <div class="player-name" id="name-player1">Player 1</div>
                    <div class="player-rank" id="rank-player1">-</div>
                </div>

                <!-- Radar Chart -->
                <div id="chart-container"></div>

                <!-- Player 2 Card -->
                <div class="player-card" id="card-player2">
                    <img id="pfp-player2" src="/images/sample_profile.png" alt="Player 2" class="player-pfp" style="border-color: #ADD8E6;">
                    <div class="player-name" id="name-player2">Player 2</div>
                    <div class="player-rank" id="rank-player2">-</div>
                </div>
            </div>

            <!-- Stats Table -->
            <div class="stats-container">
                <div class="stats-header">DETAILED STATISTICS</div>
                <div id="stats-list"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            let players = [];
            let selectedPlayer1 = null;
            let selectedPlayer2 = null;
            let player1Data = null;
            let player2Data = null;

            // Load players list
            function loadPlayersList() {
                fetch('/player_analysis/players')
                    .then(res => res.json())
                    .then(data => {
                        players = data;
                        populateSelects();
                    })
                    .catch(err => console.error('[COMPARISON] Error loading players:', err));
            }

            // Populate dropdown selects with players
            function populateSelects() {
                const select1 = document.getElementById('player1-select');
                const select2 = document.getElementById('player2-select');

                const playerOptions = players.map(p => 
                    `<option value="${p.id}">${p.summonerName || `Player ${p.id}`}</option>`
                ).join('');

                select1.innerHTML = '<option value="">Select a player...</option>' + playerOptions;
                select2.innerHTML = '<option value="">Select a player...</option>' + playerOptions;

                // Add event listeners
                select1.addEventListener('change', (e) => {
                    selectedPlayer1 = parseInt(e.target.value);
                    if (selectedPlayer1) loadPlayerData(selectedPlayer1, 1);
                });

                select2.addEventListener('change', (e) => {
                    selectedPlayer2 = parseInt(e.target.value);
                    if (selectedPlayer2) loadPlayerData(selectedPlayer2, 2);
                });
            }

            // Load player data including matches
            function loadPlayerData(playerId, playerNumber) {
                fetch(`/player_analysis/players/${playerId}`)
                    .then(res => res.json())
                    .then(player => {
                        const playerRef = playerNumber === 1 ? 'player1Data' : 'player2Data';
                        
                        if (playerNumber === 1) {
                            player1Data = player;
                            updatePlayerCard(player, 1);
                        } else {
                            player2Data = player;
                            updatePlayerCard(player, 2);
                        }

                        // Fetch match data if both players are selected
                        if (player.puuid) {
                            fetchPlayerMatches(player.puuid, playerNumber);
                        }
                    })
                    .catch(err => console.error(`[COMPARISON] Error loading player ${playerId}:`, err));
            }

            // Update player card with player info
            function updatePlayerCard(player, playerNumber) {
                const prefix = playerNumber === 1 ? 'player1' : 'player2';
                document.getElementById(`name-${prefix}`).textContent = player.summonerName || `Player ${player.id}`;
                document.getElementById(`rank-${prefix}`).textContent = player.tier ? `${player.tier} ${player.rank}` : 'Unranked';
                
                // Update profile picture if available
                const pfpEl = document.getElementById(`pfp-${prefix}`);
                if (player.profilePicture) {
                    pfpEl.src = player.profilePicture;
                }
            }

            // Fetch recent matches for a player
            function fetchPlayerMatches(puuid, playerNumber) {
                fetch(`/riot/matches/${puuid}/420?count=15`)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        // Fetch details for each match
                        const matchPromises = data.matches.slice(0, 15).map(matchId => 
                            fetch(`/riot/match/${matchId}`).then(r => r.json())
                        );
                        return Promise.all(matchPromises);
                    })
                    .then(matchDetails => {
                        calculatePlayerStats(matchDetails, playerNumber);
                        updateComparison();
                    })
                    .catch(err => console.error(`[COMPARISON] Error fetching matches for player ${playerNumber}:`, err));
            }

            // Calculate stats from matches
            function calculatePlayerStats(matches, playerNumber) {
                const puuid = playerNumber === 1 ? player1Data.puuid : player2Data.puuid;
                
                let totalKills = 0, totalDeaths = 0, totalAssists = 0;
                let totalDamage = 0, totalDamageMitigated = 0, totalGold = 0;
                let wins = 0, losses = 0;
                const champions = {};

                matches.forEach(match => {
                    const participant = match.info.participants.find(p => p.puuid === puuid);
                    if (!participant) return;

                    // KDA stats
                    totalKills += participant.kills;
                    totalDeaths += participant.deaths;
                    totalAssists += participant.assists;

                    // Damage stats
                    totalDamage += participant.totalDamageDealtToChampions;
                    totalDamageMitigated += participant.totalDamageTaken;
                    totalGold += participant.goldEarned;

                    // Win/Loss
                    if (participant.win) wins++;
                    else losses++;

                    // Champion stats
                    const champ = participant.championName;
                    if (!champions[champ]) {
                        champions[champ] = { games: 0, wins: 0, kills: 0, deaths: 0, assists: 0 };
                    }
                    champions[champ].games++;
                    if (participant.win) champions[champ].wins++;
                    champions[champ].kills += participant.kills;
                    champions[champ].deaths += participant.deaths;
                    champions[champ].assists += participant.assists;
                });

                // Store stats
                if (playerNumber === 1) {
                    player1Data.stats = {
                        avgKills: (totalKills / matches.length).toFixed(2),
                        avgDeaths: (totalDeaths / matches.length).toFixed(2),
                        avgAssists: (totalAssists / matches.length).toFixed(2),
                        kdaRatio: ((totalKills + totalAssists) / (totalDeaths || 1)).toFixed(2),
                        totalDamage: totalDamage,
                        avgDamage: (totalDamage / matches.length).toFixed(0),
                        totalDamageMitigated: totalDamageMitigated,
                        avgGold: (totalGold / matches.length).toFixed(0),
                        winrate: ((wins / matches.length) * 100).toFixed(1),
                        wins: wins,
                        losses: losses,
                        topChampions: Object.entries(champions)
                            .sort((a, b) => b[1].games - a[1].games)
                            .slice(0, 3)
                    };
                } else {
                    player2Data.stats = {
                        avgKills: (totalKills / matches.length).toFixed(2),
                        avgDeaths: (totalDeaths / matches.length).toFixed(2),
                        avgAssists: (totalAssists / matches.length).toFixed(2),
                        kdaRatio: ((totalKills + totalAssists) / (totalDeaths || 1)).toFixed(2),
                        totalDamage: totalDamage,
                        avgDamage: (totalDamage / matches.length).toFixed(0),
                        totalDamageMitigated: totalDamageMitigated,
                        avgGold: (totalGold / matches.length).toFixed(0),
                        winrate: ((wins / matches.length) * 100).toFixed(1),
                        wins: wins,
                        losses: losses,
                        topChampions: Object.entries(champions)
                            .sort((a, b) => b[1].games - a[1].games)
                            .slice(0, 3)
                    };
                }
            }

            // Calculate skill ratings (1-10 scale)
            function calculateSkillRatings(playerData) {
                if (!playerData || !playerData.stats) return null;

                const stats = playerData.stats;
                
                // Normalize KDA (higher is better)
                const kdaScore = Math.min(stats.kdaRatio * 1.5, 10);
                
                // Normalize damage (compare to average)
                const damageScore = Math.min((stats.avgDamage / 400) * 10, 10);
                
                // Normalize tank stats (damage mitigated)
                const tankScore = Math.min((stats.totalDamageMitigated / 100000) * 10, 10);
                
                // Gold efficiency
                const goldScore = Math.min((stats.avgGold / 350) * 10, 10);
                
                // Consistency (winrate)
                const consistencyScore = stats.winrate / 10;

                return {
                    kdaScore: parseFloat(kdaScore.toFixed(2)),
                    damageScore: parseFloat(damageScore.toFixed(2)),
                    tankScore: parseFloat(tankScore.toFixed(2)),
                    goldScore: parseFloat(goldScore.toFixed(2)),
                    consistencyScore: parseFloat(consistencyScore.toFixed(2))
                };
            }

            // Update the radar chart
            function updateRadarChart() {
                if (!player1Data || !player2Data || !player1Data.stats || !player2Data.stats) {
                    return;
                }

                const p1Skills = calculateSkillRatings(player1Data);
                const p2Skills = calculateSkillRatings(player2Data);

                if (!p1Skills || !p2Skills) return;

                const chartData = [
                    {
                        className: 'Player1',
                        axes: [
                            { axis: "KDA", value: p1Skills.kdaScore },
                            { axis: "Damage", value: p1Skills.damageScore },
                            { axis: "Tanking", value: p1Skills.tankScore },
                            { axis: "Gold Efficiency", value: p1Skills.goldScore },
                            { axis: "Consistency", value: p1Skills.consistencyScore }
                        ]
                    },
                    {
                        className: 'Player2',
                        axes: [
                            { axis: "KDA", value: p2Skills.kdaScore },
                            { axis: "Damage", value: p2Skills.damageScore },
                            { axis: "Tanking", value: p2Skills.tankScore },
                            { axis: "Gold Efficiency", value: p2Skills.goldScore },
                            { axis: "Consistency", value: p2Skills.consistencyScore }
                        ]
                    }
                ];

                // Clear existing chart
                document.getElementById('chart-container').innerHTML = '';

                // Configure and draw radar chart
                RadarChart.defaultConfig.w = 400;
                RadarChart.defaultConfig.h = 400;
                RadarChart.defaultConfig.radius = 5;
                RadarChart.defaultConfig.maxValue = 10;
                RadarChart.draw("#chart-container", chartData);
            }

            // Update stats table
            function updateStatsTable() {
                if (!player1Data || !player2Data || !player1Data.stats || !player2Data.stats) {
                    document.getElementById('stats-list').innerHTML = '<div class="no-data">Select both players to view detailed statistics</div>';
                    return;
                }

                const stats = player1Data.stats;
                const stats2 = player2Data.stats;

                const statRows = [
                    { label: "Winrate", p1: `${stats.winrate}%`, p2: `${stats2.winrate}%` },
                    { label: "W/L Record", p1: `${stats.wins}W ${stats.losses}L`, p2: `${stats2.wins}W ${stats2.losses}L` },
                    { label: "Avg KDA", p1: `${stats.avgKills}/${stats.avgDeaths}/${stats.avgAssists}`, p2: `${stats2.avgKills}/${stats2.avgDeaths}/${stats2.avgAssists}` },
                    { label: "KDA Ratio", p1: stats.kdaRatio, p2: stats2.kdaRatio },
                    { label: "Avg Damage", p1: parseInt(stats.avgDamage).toLocaleString(), p2: parseInt(stats2.avgDamage).toLocaleString() },
                    { label: "Total Damage", p1: stats.totalDamage.toLocaleString(), p2: stats2.totalDamage.toLocaleString() },
                    { label: "Avg Gold", p1: parseInt(stats.avgGold).toLocaleString(), p2: parseInt(stats2.avgGold).toLocaleString() },
                    { label: "Damage Mitigated", p1: stats.totalDamageMitigated.toLocaleString(), p2: stats2.totalDamageMitigated.toLocaleString() }
                ];

                const statsList = document.getElementById('stats-list');
                statsList.innerHTML = statRows.map(stat => `
                    <div class="stat-row">
                        <span>${stat.p1}</span>
                        <span>${stat.label}</span>
                        <span>${stat.p2}</span>
                    </div>
                `).join('');
            }

            // Update comparison view
            function updateComparison() {
                updateRadarChart();
                updateStatsTable();
            }

            // Initialize
            loadPlayersList();
        });
    </script>
</body>
</html>